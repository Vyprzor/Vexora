<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vexora Chat</title>
     <link rel="icon" type="image/png" href="favicon.png">    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 900px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header h1 {
            font-size: 26px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .user-badge:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            color: white;
            cursor: pointer;
            background-size: cover;
            background-position: center;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
        }

        .sign-out-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
        }

        .sign-out-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Login/Register Screen */
        .auth-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            gap: 20px;
        }

        .auth-screen h2 {
            color: #1f2937;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .auth-screen p {
            color: #6b7280;
            text-align: center;
            max-width: 500px;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .auth-tab {
            padding: 10px 30px;
            background: #f3f4f6;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: #6b7280;
        }

        .auth-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .auth-form {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-form input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .auth-form input:focus {
            outline: none;
            border-color: #667eea;
        }

        .auth-form textarea {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .auth-form textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .auth-form button {
            padding: 15px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .auth-form button:hover {
            transform: translateY(-2px);
        }

        .auth-form button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Chat Screen */
        .chat-screen {
            flex: 1;
            display: none;
            flex-direction: column;
        }

        .chat-screen.active {
            display: flex;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px 30px;
            background: #f9fafb;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            color: white;
            flex-shrink: 0;
            cursor: pointer;
            transition: transform 0.2s;
            background-size: cover;
            background-position: center;
        }

        .message-avatar:hover {
            transform: scale(1.1);
        }

        .message-body {
            flex: 1;
            min-width: 0;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .message-username {
            font-weight: 600;
            color: #1f2937;
            cursor: pointer;
        }

        .message-username:hover {
            text-decoration: underline;
        }

        .message-time {
            font-size: 12px;
            color: #9ca3af;
        }

        .message-content-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .message-content {
            background: white;
            padding: 12px 16px;
            border-radius: 12px;
            border-left: 3px solid #667eea;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
            flex: 1;
            max-width: 100%;
        }

        .delete-btn {
            background: #fee2e2;
            border: none;
            color: #ef4444;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .message:hover .delete-btn {
            opacity: 1;
        }

        .delete-btn:hover {
            background: #fecaca;
            transform: scale(1.1);
        }

        .message.own {
            flex-direction: row-reverse;
        }

        .message.own .message-header {
            justify-content: flex-end;
        }

        .message.own .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-left: none;
            border-right: 3px solid rgba(255, 255, 255, 0.5);
        }

        .input-area {
            padding: 20px 30px;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 10px;
        }

        .input-area input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 25px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .input-area input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-area button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .input-area button:hover {
            transform: scale(1.05);
        }

        .input-area button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 24px;
            color: #1f2937;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #9ca3af;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f3f4f6;
            color: #1f2937;
        }

        .profile-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .profile-avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 50px;
            color: white;
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .profile-info {
            text-align: center;
            width: 100%;
        }

        .profile-display-name {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .profile-username {
            font-size: 16px;
            color: #6b7280;
            margin-bottom: 15px;
        }

        .profile-bio {
            font-size: 16px;
            color: #4b5563;
            line-height: 1.6;
            background: #f9fafb;
            padding: 15px;
            border-radius: 10px;
        }

        .profile-edit-form {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .profile-edit-form input,
        .profile-edit-form textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .profile-edit-form input:focus,
        .profile-edit-form textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .profile-edit-form textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .profile-edit-form button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }

        .profile-edit-form button:hover {
            transform: translateY(-2px);
        }

        .profile-edit-form button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .avatar-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .avatar-option-btn {
            flex: 1;
            padding: 10px;
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .avatar-option-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .color-picker-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .color-option {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: #1f2937;
            transform: scale(1.15);
        }

        .image-upload-section {
            display: none;
        }

        .image-upload-section.active {
            display: block;
        }

        .color-section {
            display: none;
        }

        .color-section.active {
            display: block;
        }

        .upload-area {
            border: 2px dashed #e5e7eb;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f9fafb;
        }

        .upload-area input {
            display: none;
        }

        .preview-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            margin: 10px auto;
            display: block;
        }

        .remove-image-btn {
            margin-top: 10px;
            padding: 8px 16px;
            background: #fee2e2;
            color: #ef4444;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .remove-image-btn:hover {
            background: #fecaca;
        }

        .error {
            color: #ef4444;
            background: #fee2e2;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .success {
            color: #059669;
            background: #d1fae5;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 15px;
        }

        /* Scrollbar Styles */
        .messages::-webkit-scrollbar {
            width: 8px;
        }

        .messages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .messages::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .messages::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        .change-avatar-btn {
            padding: 8px 16px;
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .change-avatar-btn:hover {
            background: #e5e7eb;
        }

        /* Avatar Preview */
        .avatar-preview-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .avatar-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 40px;
            color: white;
            background-size: cover;
            background-position: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 30px 40px;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .loading-spinner {
            border: 4px solid #e5e7eb;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
        }

        .loading-text {
            color: #1f2937;
            font-weight: 600;
            font-size: 16px;
        }

        /* Delete Confirmation Modal */
        .confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .confirm-modal.active {
            display: flex;
        }

        .confirm-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .confirm-title {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 10px;
        }

        .confirm-message {
            color: #6b7280;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .confirm-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .confirm-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .confirm-btn.cancel {
            background: #f3f4f6;
            color: #1f2937;
        }

        .confirm-btn.cancel:hover {
            background: #e5e7eb;
        }

        .confirm-btn.delete {
            background: #ef4444;
            color: white;
        }

        .confirm-btn.delete:hover {
            background: #dc2626;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>Vexora</h1>
                <div class="status">
                    <div class="status-dot"></div>
                    <span id="statusText">Ready</span>
                </div>
            </div>
            <div class="header-right" id="headerRight" style="display: none;">
                <div class="user-badge" id="userBadge">
                    <div class="user-avatar" id="headerAvatar"></div>
                    <span class="user-name" id="headerName"></span>
                </div>
                <button class="sign-out-btn" id="signOutBtn">Sign Out</button>
            </div>
        </div>

        <!-- Auth Screen -->
        <div class="auth-screen" id="authScreen">
            <h2>Welcome to Vexora</h2>
            <p>By Zaydon</p>

            <div class="auth-tabs">
                <button class="auth-tab active" id="loginTab">Login</button>
                <button class="auth-tab" id="registerTab">Register</button>
            </div>

            <!-- Login Form -->
            <div class="auth-form" id="loginForm">
                <input type="text" id="loginUsername" placeholder="Username" />
                <input type="password" id="loginPassword" placeholder="Password" />
                <div id="loginError"></div>
                <button id="loginBtn">Login</button>
            </div>

            <!-- Register Form -->
            <div class="auth-form" id="registerForm" style="display: none;">
                <input type="text" id="regUsername" placeholder="Username" />
                <input type="password" id="regPassword" placeholder="Password" />
                <input type="text" id="regDisplayName" placeholder="Display Name" />
                <textarea id="regBio" placeholder="Bio (optional)"></textarea>
                <div id="registerError"></div>
                <button id="registerBtn">Create Account</button>
            </div>
        </div>

        <!-- Chat Screen -->
        <div class="chat-screen" id="chatScreen">
            <div class="messages" id="messages"></div>
            <div class="input-area">
                <input type="text" id="messageInput" placeholder="Type a message..." />
                <button id="sendBtn">Send</button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">Profile</h3>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading...</div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-content">
            <div class="confirm-title">Delete Message?</div>
            <div class="confirm-message">Are you sure you want to delete this message? This action cannot be undone.</div>
            <div class="confirm-buttons">
                <button class="confirm-btn cancel" id="confirmCancel">Cancel</button>
                <button class="confirm-btn delete" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURATION
        const SHEET_URL = 'https://script.google.com/macros/s/AKfycbyfsGWzB6edZuqdKC6Rn6ktYBbhi-bV_nPFKDVWSWn5jW4SIY61OG1vJTZWareEzydV8w/exec';
        
        // Color Palette
        const COLOR_PALETTE = [
  // reds
  '#2b0000','#4a0000','#6b0000','#8b0000','#b30000','#d40000','#ff0000',
  '#ff2b2b','#ff5555','#ff7f7f','#ffaaaa','#ffd5d5',

  // oranges
  '#331a00','#663300','#994d00','#cc6600','#ff8000','#ff9933',
  '#ffb366','#ffcc99','#ffe6cc',

  // yellows
  '#333300','#666600','#999900','#cccc00','#ffff00','#ffff33',
  '#ffff66','#ffff99','#ffffcc',

  // yellow-greens
  '#263300','#4d6600','#739900','#99cc00','#bfff00',
  '#ccff33','#d9ff66','#e6ff99','#f2ffcc',

  // greens
  '#003300','#006600','#009900','#00cc00','#00ff00',
  '#33ff33','#66ff66','#99ff99','#ccffcc',

  // teal-greens
  '#003326','#00664d','#009973','#00cc99','#00ffbf',
  '#33ffd1','#66ffe0','#99ffef','#ccfffa',

  // teals
  '#003333','#006666','#009999','#00cccc','#00ffff',
  '#33ffff','#66ffff','#99ffff','#ccffff',

  // cyan-blues
  '#002633','#004d66','#007399','#0099cc','#00bfff',
  '#33ccff','#66d9ff','#99e6ff','#ccefff',

  // blues
  '#000033','#000066','#000099','#0000cc','#0000ff',
  '#3333ff','#6666ff','#9999ff','#ccccff',

  // indigos
  '#1a0033','#330066','#4d0099','#6600cc','#8000ff',
  '#9933ff','#b266ff','#cc99ff','#e6ccff',

  // purples
  '#260026','#4d004d','#730073','#990099','#bf00bf',
  '#d633d6','#e066e0','#f099f0','#f5ccf5',

  // pinks
  '#33001a','#660033','#99004d','#cc0066','#ff0080',
  '#ff3399','#ff66b2','#ff99cc','#ffccdd',

  // magentas
  '#330033','#660066','#990099','#cc00cc','#ff00ff',
  '#ff33ff','#ff66ff','#ff99ff','#ffccff',

  // browns
  '#1f1206','#3e240c','#5c3612','#7a4818','#995a1e',
  '#b87c4a','#d1a173','#ead0b0',

  // grays
  '#000000','#1a1a1a','#333333','#4d4d4d','#666666',
  '#808080','#999999','#b3b3b3','#cccccc','#e6e6e6','#ffffff'
];
        // State
        let currentUser = null;
        let allProfiles = {};
        let allMessages = [];
        let pollInterval;
        let selectedColor = COLOR_PALETTE[0];
        let selectedImage = null;
        let avatarMode = 'color';
        let messageToDelete = null;
        let lastMessageHash = '';

        // Elements
        const authScreen = document.getElementById('authScreen');
        const chatScreen = document.getElementById('chatScreen');
        const loginTab = document.getElementById('loginTab');
        const registerTab = document.getElementById('registerTab');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const headerRight = document.getElementById('headerRight');
        const headerAvatar = document.getElementById('headerAvatar');
        const headerName = document.getElementById('headerName');
        const userBadge = document.getElementById('userBadge');
        const signOutBtn = document.getElementById('signOutBtn');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const messagesDiv = document.getElementById('messages');
        const profileModal = document.getElementById('profileModal');
        const modalContent = document.getElementById('modalContent');
        const closeModal = document.getElementById('closeModal');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const confirmModal = document.getElementById('confirmModal');
        const confirmCancel = document.getElementById('confirmCancel');
        const confirmDelete = document.getElementById('confirmDelete');

        // Show/Hide Loading
        function showLoading(text = 'Loading...') {
            document.querySelector('.loading-text').textContent = text;
            loadingOverlay.classList.add('active');
        }

        function hideLoading() {
            loadingOverlay.classList.remove('active');
        }

        // Generate hash for messages to detect changes
        function hashMessages(messages) {
            return JSON.stringify(messages.map(m => m.timestamp + m.username + m.message));
        }

        // Tab Switching
        loginTab.addEventListener('click', () => {
            loginTab.classList.add('active');
            registerTab.classList.remove('active');
            loginForm.style.display = 'flex';
            registerForm.style.display = 'none';
        });

        registerTab.addEventListener('click', () => {
            registerTab.classList.add('active');
            loginTab.classList.remove('active');
            registerForm.style.display = 'flex';
            loginForm.style.display = 'none';
        });

        // Login
        document.getElementById('loginBtn').addEventListener('click', async () => {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!username || !password) {
                showError('loginError', 'Please fill in all fields');
                return;
            }

            showLoading('Logging in...');

            try {
                const response = await fetch(SHEET_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({
                        action: 'login',
                        username: username,
                        password: password
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    currentUser = data.user;
                    await showChatScreen();
                } else {
                    showError('loginError', data.message);
                }
            } catch (error) {
                console.error('Login error:', error);
                showError('loginError', 'Connection error. Please try again.');
            }

            hideLoading();
        });

        // Register
        document.getElementById('registerBtn').addEventListener('click', async () => {
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value.trim();
            const displayName = document.getElementById('regDisplayName').value.trim();
            const bio = document.getElementById('regBio').value.trim();

            if (!username || !password || !displayName) {
                showError('registerError', 'Please fill in username, password, and display name');
                return;
            }

            showLoading('Creating account...');

            try {
                const response = await fetch(SHEET_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({
                        action: 'register',
                        username: username,
                        password: password,
                        displayName: displayName,
                        bio: bio
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    currentUser = data.user;
                    await showChatScreen();
                } else {
                    showError('registerError', data.message);
                }
            } catch (error) {
                console.error('Register error:', error);
                showError('registerError', 'Connection error. Please try again.');
            }

            hideLoading();
        });

        // Show Chat Screen
        async function showChatScreen() {
            authScreen.style.display = 'none';
            chatScreen.classList.add('active');
            headerRight.style.display = 'flex';
            
            updateHeader();
            
            showLoading('Loading messages...');
            await loadAllProfiles();
            await loadMessages();
            hideLoading();
            
            startPolling();
            messageInput.focus();
        }

        // Update Header
        function updateHeader() {
            if (currentUser.profilePic) {
                headerAvatar.style.backgroundImage = `url(${currentUser.profilePic})`;
                headerAvatar.textContent = '';
            } else {
                headerAvatar.style.backgroundColor = currentUser.color;
                headerAvatar.style.backgroundImage = 'none';
                headerAvatar.textContent = currentUser.displayName.charAt(0).toUpperCase();
            }
            headerName.textContent = currentUser.displayName;
        }

        // Sign Out
        signOutBtn.addEventListener('click', () => {
            currentUser = null;
            allMessages = [];
            lastMessageHash = '';
            chatScreen.classList.remove('active');
            authScreen.style.display = 'flex';
            headerRight.style.display = 'none';
            messagesDiv.innerHTML = '';
            if (pollInterval) clearInterval(pollInterval);
        });

        // Open Profile Modal
        userBadge.addEventListener('click', () => {
            showProfileEdit();
        });

        // Close Modal
        closeModal.addEventListener('click', () => {
            profileModal.classList.remove('active');
        });

        profileModal.addEventListener('click', (e) => {
            if (e.target === profileModal) {
                profileModal.classList.remove('active');
            }
        });

        // Confirm Modal
        confirmCancel.addEventListener('click', () => {
            confirmModal.classList.remove('active');
            messageToDelete = null;
        });

        confirmDelete.addEventListener('click', async () => {
            if (messageToDelete) {
                confirmModal.classList.remove('active');
                await executeDelete(messageToDelete);
                messageToDelete = null;
            }
        });

        // Update Avatar Preview
        function updateAvatarPreview() {
            const preview = document.getElementById('avatarPreview');
            if (!preview) return;

            if (avatarMode === 'image' && selectedImage) {
                preview.style.backgroundImage = `url(${selectedImage})`;
                preview.textContent = '';
            } else {
                preview.style.backgroundColor = selectedColor;
                preview.style.backgroundImage = 'none';
                preview.textContent = currentUser.displayName.charAt(0).toUpperCase();
            }
        }

        // Remove Image
        window.removeImage = function() {
            selectedImage = null;
            avatarMode = 'color';
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('imageUrl').value = '';
            const fileInput = document.getElementById('imageUpload');
            if (fileInput) fileInput.value = '';
            
            document.querySelectorAll('.avatar-option-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('[data-mode="color"]').classList.add('active');
            document.querySelector('.color-section').classList.add('active');
            document.querySelector('.image-upload-section').classList.remove('active');
            
            updateAvatarPreview();
        }

        // Show Profile Edit
        function showProfileEdit() {
            document.getElementById('modalTitle').textContent = 'Edit Profile';
            
            if (currentUser.profilePic) {
                avatarMode = 'image';
                selectedImage = currentUser.profilePic;
                selectedColor = currentUser.color;
            } else {
                avatarMode = 'color';
                selectedColor = currentUser.color;
                selectedImage = null;
            }

            const avatarDisplay = currentUser.profilePic 
                ? `<div class="profile-avatar-large" style="background-image: url(${currentUser.profilePic})"></div>`
                : `<div class="profile-avatar-large" style="background-color: ${currentUser.color}">${currentUser.displayName.charAt(0).toUpperCase()}</div>`;

            modalContent.innerHTML = `
                <div class="profile-view">
                    ${avatarDisplay}
                    <button class="change-avatar-btn" id="changeAvatarBtn">Change Avatar</button>
                </div>
                
                <div id="avatarEditor" style="display: none;">
                    <div class="avatar-preview-container">
                        <div class="avatar-preview" id="avatarPreview"></div>
                    </div>
                    
                    <div class="avatar-options">
                        <button class="avatar-option-btn ${avatarMode === 'color' ? 'active' : ''}" data-mode="color">Color</button>
                        <button class="avatar-option-btn ${avatarMode === 'image' ? 'active' : ''}" data-mode="image">Image</button>
                    </div>
                    
                    <div class="color-section ${avatarMode === 'color' ? 'active' : ''}">
                        <div class="color-picker-grid" id="colorPicker"></div>
                    </div>
                    
                    <div class="image-upload-section ${avatarMode === 'image' ? 'active' : ''}">
                        <div class="upload-area" id="uploadArea">
                            <input type="file" id="imageUpload" accept="image/*" />
                            <p>Click to upload an image</p>
                            <small style="color: #6b7280;">Or paste an image URL below</small>
                        </div>
                        <input type="text" id="imageUrl" placeholder="Or paste image URL here" value="${selectedImage || ''}" style="margin-top: 10px; width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;" />
                        <div id="imagePreview">${selectedImage ? `<img src="${selectedImage}" class="preview-image" /><button class="remove-image-btn" onclick="removeImage()">Remove Image</button>` : ''}</div>
                    </div>
                </div>

                <div class="profile-edit-form">
                    <input type="text" id="editDisplayName" placeholder="Display Name" value="${escapeHtml(currentUser.displayName)}" />
                    <textarea id="editBio" placeholder="Bio">${escapeHtml(currentUser.bio || '')}</textarea>
                    <div id="profileError"></div>
                    <button id="saveProfileBtn">Save Changes</button>
                </div>
            `;
            
            profileModal.classList.add('active');

            updateAvatarPreview();

            const colorPicker = document.getElementById('colorPicker');
            COLOR_PALETTE.forEach(color => {
                const colorDiv = document.createElement('div');
                colorDiv.className = 'color-option';
                colorDiv.style.backgroundColor = color;
                if (color === selectedColor) {
                    colorDiv.classList.add('selected');
                }
                colorDiv.addEventListener('click', () => {
                    document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
                    colorDiv.classList.add('selected');
                    selectedColor = color;
                    updateAvatarPreview();
                });
                colorPicker.appendChild(colorDiv);
            });

            document.querySelectorAll('.avatar-option-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.avatar-option-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    avatarMode = btn.dataset.mode;
                    
                    if (avatarMode === 'color') {
                        document.querySelector('.color-section').classList.add('active');
                        document.querySelector('.image-upload-section').classList.remove('active');
                    } else {
                        document.querySelector('.color-section').classList.remove('active');
                        document.querySelector('.image-upload-section').classList.add('active');
                    }
                    updateAvatarPreview();
                });
            });

            document.getElementById('changeAvatarBtn').addEventListener('click', () => {
                const editor = document.getElementById('avatarEditor');
                editor.style.display = editor.style.display === 'none' ? 'block' : 'none';
            });

            const uploadArea = document.getElementById('uploadArea');
            const imageUpload = document.getElementById('imageUpload');
            const imageUrl = document.getElementById('imageUrl');
            const imagePreview = document.getElementById('imagePreview');

            uploadArea.addEventListener('click', () => imageUpload.click());

            imageUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 1 * 1024 * 1024) {
                        showError('profileError', 'Image must be less than 1MB for Google Sheets');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        selectedImage = e.target.result;
                        imagePreview.innerHTML = `<img src="${selectedImage}" class="preview-image" /><button class="remove-image-btn" onclick="removeImage()">Remove Image</button>`;
                        updateAvatarPreview();
                    };
                    reader.onerror = () => {
                        showError('profileError', 'Failed to read image file');
                    };
                    reader.readAsDataURL(file);
                }
            });

            imageUrl.addEventListener('input', (e) => {
                const url = e.target.value.trim();
                if (url) {
                    selectedImage = url;
                    imagePreview.innerHTML = `<img src="${url}" class="preview-image" onerror="this.style.display='none'" /><button class="remove-image-btn" onclick="removeImage()">Remove Image</button>`;
                    updateAvatarPreview();
                } else {
                    selectedImage = null;
                    imagePreview.innerHTML = '';
                    updateAvatarPreview();
                }
            });

            document.getElementById('saveProfileBtn').addEventListener('click', saveProfile);
        }

        // Save Profile
        async function saveProfile() {
            const displayName = document.getElementById('editDisplayName').value.trim();
            const bio = document.getElementById('editBio').value.trim();
            const saveBtn = document.getElementById('saveProfileBtn');

            if (!displayName) {
                showError('profileError', 'Display name cannot be empty');
                return;
            }

            saveBtn.disabled = true;
            saveBtn.innerHTML = 'Saving... <span class="spinner"></span>';

            try {
                const profileData = {
                    action: 'updateProfile',
                    username: currentUser.username,
                    displayName: displayName,
                    bio: bio
                };

                if (avatarMode === 'color') {
                    profileData.color = selectedColor;
                    profileData.profilePic = '';
                } else if (avatarMode === 'image' && selectedImage) {
                    profileData.profilePic = selectedImage;
                    profileData.color = selectedColor;
                } else {
                    profileData.color = selectedColor;
                    profileData.profilePic = '';
                }

                const response = await fetch(SHEET_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify(profileData)
                });

                const data = await response.json();

                if (data.status === 'success') {
                    currentUser = data.user;
                    updateHeader();
                    profileModal.classList.remove('active');
                    await loadAllProfiles();
                    
                    // Force reload messages to show updated profile
                    lastMessageHash = '';
                    await loadMessages();
                } else {
                    showError('profileError', data.message);
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save Changes';
                }
            } catch (error) {
                console.error('Save profile error:', error);
                showError('profileError', 'Connection error: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
            }
        }

        // Show User Profile
        function showUserProfile(username) {
            const user = allProfiles[username];
            if (!user) return;

            document.getElementById('modalTitle').textContent = 'User Profile';
            
            const avatarDisplay = user.profilePic 
                ? `<div class="profile-avatar-large" style="background-image: url(${user.profilePic})"></div>`
                : `<div class="profile-avatar-large" style="background-color: ${user.color}">${user.displayName.charAt(0).toUpperCase()}</div>`;

            modalContent.innerHTML = `
                <div class="profile-view">
                    ${avatarDisplay}
                    <div class="profile-info">
                        <div class="profile-display-name">${escapeHtml(user.displayName)}</div>
                        <div class="profile-username">@${escapeHtml(user.username)}</div>
                        ${user.bio ? `<div class="profile-bio">${escapeHtml(user.bio)}</div>` : ''}
                    </div>
                </div>
            `;
            
            profileModal.classList.add('active');
        }

        // Load All Profiles
        async function loadAllProfiles() {
            try {
                const response = await fetch(SHEET_URL + '?action=getAllProfiles');
                const data = await response.json();
                
                if (data.status === 'success') {
                    allProfiles = {};
                    data.users.forEach(user => {
                        allProfiles[user.username] = user;
                    });
                }
            } catch (error) {
                console.error('Failed to load profiles:', error);
            }
        }

        // Show Delete Confirmation
        window.showDeleteConfirmation = function(timestamp, username) {
            messageToDelete = { timestamp, username };
            confirmModal.classList.add('active');
        }

        // Execute Delete
        async function executeDelete(msgData) {
            showLoading('Deleting message...');

            try {
                const response = await fetch(SHEET_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({
                        action: 'deleteMessage',
                        timestamp: msgData.timestamp,
                        username: msgData.username
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    // Force reload by clearing hash
                    lastMessageHash = '';
                    await loadMessages();
                } else {
                    alert('Failed to delete message: ' + data.message);
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Connection error: ' + error.message);
            }

            hideLoading();
        }

        // Send Message
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            sendBtn.disabled = true;
            
            try {
                const response = await fetch(SHEET_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({
                        action: 'write',
                        username: currentUser.username,
                        message: message
                    })
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    messageInput.value = '';
                    // Force reload
                    lastMessageHash = '';
                    await loadMessages();
                }
            } catch (error) {
                console.error('Send error:', error);
            }
            
            sendBtn.disabled = false;
            messageInput.focus();
        }

        // Load Messages
        async function loadMessages() {
            try {
                const response = await fetch(SHEET_URL + '?action=read&_=' + Date.now());
                const data = await response.json();
                
                if (data.status === 'success' && data.messages) {
                    const newHash = hashMessages(data.messages);
                    
                    // Only update if messages actually changed
                    if (newHash !== lastMessageHash) {
                        allMessages = data.messages;
                        lastMessageHash = newHash;
                        displayMessages(allMessages);
                    }
                }
            } catch (error) {
                console.error('Load error:', error);
            }
        }

        // Display Messages
        function displayMessages(messages) {
            const wasAtBottom = messagesDiv.scrollHeight - messagesDiv.scrollTop <= messagesDiv.clientHeight + 50;
            
            messagesDiv.innerHTML = '';
            
            messages.forEach(msg => {
                const isOwn = msg.username === currentUser.username;
                const user = allProfiles[msg.username] || { 
                    displayName: msg.username, 
                    color: '#999', 
                    bio: '',
                    profilePic: ''
                };
                
                const messageEl = document.createElement('div');
                messageEl.className = isOwn ? 'message own' : 'message';
                
                const time = new Date(msg.timestamp).toLocaleTimeString([], { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });

                const avatarStyle = user.profilePic 
                    ? `background-image: url(${user.profilePic})`
                    : `background-color: ${user.color}`;
                const avatarText = user.profilePic ? '' : user.displayName.charAt(0).toUpperCase();
                
                // Store timestamp as string
                const timestampStr = new Date(msg.timestamp).toISOString();
                
                const deleteButton = isOwn ? `
                    <button class="delete-btn" onclick="showDeleteConfirmation('${timestampStr}', '${escapeHtml(msg.username)}')" title="Delete message">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6"/>
                        </svg>
                    </button>
                ` : '';

                messageEl.innerHTML = `
                    <div class="message-avatar" style="${avatarStyle}" onclick="if('${msg.username}' !== '${currentUser.username}') showUserProfile('${escapeHtml(msg.username)}')">
                        ${avatarText}
                    </div>
                    <div class="message-body">
                        <div class="message-header">
                            <span class="message-username" onclick="if('${msg.username}' !== '${currentUser.username}') showUserProfile('${escapeHtml(msg.username)}')">${escapeHtml(user.displayName)}</span>
                            <span class="message-time">${time}</span>
                        </div>
                        <div class="message-content-wrapper">
                            <div class="message-content">${escapeHtml(msg.message)}</div>
                            ${deleteButton}
                        </div>
                    </div>
                `;
                
                messagesDiv.appendChild(messageEl);
            });
            
            if (wasAtBottom || messagesDiv.scrollTop === 0) {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }

        // Start Polling
        function startPolling() {
            pollInterval = setInterval(async () => {
                await loadMessages();
                await loadAllProfiles();
            }, 3000);
        }

        // Utility Functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(elementId, message) {
            const el = document.getElementById(elementId);
            if (el) {
                el.innerHTML = `<div class="error">${message}</div>`;
                setTimeout(() => {
                    el.innerHTML = '';
                }, 5000);
            }
        }

        window.addEventListener('beforeunload', () => {
            if (pollInterval) clearInterval(pollInterval);
        });

        // Make showUserProfile global
        window.showUserProfile = showUserProfile;
    </script>
</body>
</html>
